# Show the average amount paid by the top 5 customers using a CTE

WITH total_paid (total_amount_paid) AS (SELECT SUM(E.amount) AS total_amount_paid
                                        FROM customer A
                                        JOIN address B ON A.address_id = B.address_id
                                        JOIN city C ON B.city_id = C.city_id
                                        JOIN country D ON C.country_id = D.country_id
                                        JOIN payment E ON A.customer_id = E.customer_id
                                        WHERE C.City IN ('London',
                                                         'Aurora',
                                                         'Santiago de Compostela',
                                                         'Iwaki',
                                                         'Shanwei',
                                                         'Nador',
                                                         'Tianjin',
                                                         'Benguela',
                                                         'Rustenburg',
                                                         'Newcastle')
                                        GROUP BY D.country, 
                                                 C.city, 
                                                 A.first_name, 
                                                 A.last_name, 
                                                 A.customer_id
                                        ORDER BY total_amount_paid DESC
                                        LIMIT 5)
SELECT AVG(total_amount_paid) AS average
FROM total_paid
